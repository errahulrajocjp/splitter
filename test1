@Test
void testCheck5GCoverageForAddresses_WithAptNumberInSplitResponse() {
    // Setup
    FiveGCoverageCheckRequest request = createValidFiveGRequest();

    // **FIX 1: Mock buildSplitCustomerAddressRequest**
    SplitAddressRequest splitAddressRequest = new SplitAddressRequest();
    when(fiveGCoverageCheckHelper.buildSplitCustomerAddressRequest(any(CustomerAddress.class)))
        .thenReturn(splitAddressRequest);

    SplitAddressResponse splitResponse = createValidSplitAddressResponse();
    splitResponse.getData().getAddressSplit().getResponse().getAddress().setAptNum("Apt 5B");
    when(spectrumAdapterService.splitAddress(any())).thenReturn(Mono.just(splitResponse));

    // Create a properly structured Nautilus response
    NautilusQualificationResponse nautilusResponse = new NautilusQualificationResponse();
    NautilusData data = new NautilusData();
    BulkAddressQualificationResponse qualificationResponse = new BulkAddressQualificationResponse();

    qualificationResponse.setRecordIdentifier("1");
    qualificationResponse.setReturnCode("00");
    qualificationResponse.setFiveGHomeQualified(true);
    qualificationResponse.setReturnMessage("Qualified");

    // Add AddressInfo
    AddressInfo addressInfo = new AddressInfo();
    addressInfo.setAddressId("123");
    addressInfo.setFuzeSiteId("456");
    addressInfo.setSector("789");
    qualificationResponse.setAddressInfo(addressInfo);

    // Add AvailableCapacityInfo
    AvailableCapacityInfo capacityInfo = new AvailableCapacityInfo();
    capacityInfo.setCbandCapacity("100");
    capacityInfo.setLteCapacity("50");
    qualificationResponse.setAvailableCapacityInfo(capacityInfo);

    data.setBulkAddressQualificationResponse(List.of(qualificationResponse));
    nautilusResponse.setData(data);

    // **FIX 2: Mock buildNautilusQualificationRequest**
    NautilusQualificationRequest nautilusRequest = new NautilusQualificationRequest();
    when(fiveGCoverageCheckHelper.buildNautilusQualificationRequest(anyList()))
        .thenReturn(nautilusRequest);

    when(spectrumAdapterService.checkAddressQualification(any()))
        .thenReturn(Mono.just(nautilusResponse));

    // Execute
    StepVerifier.create(validateBusinessAccountHelper.check5GCoverageForAddresses(request))
        .assertNext(response -> {
            assertNotNull(response);
            assertNotNull(response.getData());
            assertNotNull(response.getData().getResponse());
            FiveGCoverageCheckResponse coverageResponse = response.getData().getResponse();
            assertNotNull(coverageResponse.getCustomerAddress());
            assertFalse(coverageResponse.getCustomerAddress().isEmpty());
            assertEquals("Apt 5B", coverageResponse.getCustomerAddress().get(0).getAddressLine2());
        })
        .verifyComplete();
}
