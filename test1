// =====================================================================
// ADDITIONAL TEST CASES FOR 100% LINE AND BRANCH COVERAGE
// Add these test methods to your existing ValidateBusinessAccountHelperTest class
// =====================================================================

// ==================== IMPORTS NEEDED ====================
import org.springframework.test.util.ReflectionTestUtils;

// ==================== LINE 16: return defaultValue (parseIntegerSafely/parseDoubleSafely) ====================

@Nested
@DisplayName("Parse Methods - Default Value Return Coverage")
class ParseMethodsDefaultValueCoverageTests {

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseIntegerSafely when value is null
     */
    @Test
    @DisplayName("parseIntegerSafely - null value returns defaultValue")
    void testParseIntegerSafely_NullValue_ReturnsDefault() {
        // Use ReflectionTestUtils to invoke private method
        Integer result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseIntegerSafely",
                null,           // value is null
                "testField",    // fieldName
                42              // defaultValue
        );
        
        assertEquals(42, result);
    }

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseIntegerSafely when value is empty string
     */
    @Test
    @DisplayName("parseIntegerSafely - empty value returns defaultValue")
    void testParseIntegerSafely_EmptyValue_ReturnsDefault() {
        Integer result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseIntegerSafely",
                "",             // value is empty
                "testField",
                99
        );
        
        assertEquals(99, result);
    }

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseDoubleSafely when value is null
     */
    @Test
    @DisplayName("parseDoubleSafely - null value returns defaultValue")
    void testParseDoubleSafely_NullValue_ReturnsDefault() {
        Double result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseDoubleSafely",
                null,           // value is null
                "testField",
                3.14            // defaultValue
        );
        
        assertEquals(3.14, result, 0.001);
    }

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseDoubleSafely when value is empty string
     */
    @Test
    @DisplayName("parseDoubleSafely - empty value returns defaultValue")
    void testParseDoubleSafely_EmptyValue_ReturnsDefault() {
        Double result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseDoubleSafely",
                "",             // value is empty
                "testField",
                2.71
        );
        
        assertEquals(2.71, result, 0.001);
    }

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseDoubleToIntSafely when value is null
     */
    @Test
    @DisplayName("parseDoubleToIntSafely - null value returns defaultValue")
    void testParseDoubleToIntSafely_NullValue_ReturnsDefault() {
        Integer result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseDoubleToIntSafely",
                null,           // value is null
                "testField",
                50
        );
        
        assertEquals(50, result);
    }

    /**
     * Covers Line 16: return defaultValue;
     * Target: parseDoubleToIntSafely when value is empty string
     */
    @Test
    @DisplayName("parseDoubleToIntSafely - empty value returns defaultValue")
    void testParseDoubleToIntSafely_EmptyValue_ReturnsDefault() {
        Integer result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "parseDoubleToIntSafely",
                "",             // value is empty
                "testField",
                75
        );
        
        assertEquals(75, result);
    }
}

// ==================== LINE 18-20: createCustomerAddressCopy with null original ====================

@Nested
@DisplayName("createCustomerAddressCopy - Null Original Coverage")
class CreateCustomerAddressCopyNullCoverageTests {

    /**
     * Covers Line 18: if (original == null) {
     * Covers Line 20: return new CustomerAddress();
     */
    @Test
    @DisplayName("createCustomerAddressCopy - null original returns new empty CustomerAddress")
    void testCreateCustomerAddressCopy_NullOriginal_ReturnsNewCustomerAddress() {
        // Use ReflectionTestUtils to invoke private method with null
        CustomerAddress result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "createCustomerAddressCopy",
                (CustomerAddress) null  // original is null
        );
        
        // Verify a new CustomerAddress is returned
        assertNotNull(result);
        assertNull(result.getAddressLine1());
        assertNull(result.getAddressLine2());
        assertNull(result.getCity());
        assertNull(result.getState());
        assertNull(result.getZipCode());
        assertNull(result.getAddressType());
        assertFalse(result.isQualified());
        assertNull(result.getStatusMsg());
    }
}

// ==================== LINES 3,5,6,8: mapEligibilities filter branches ====================

@Nested
@DisplayName("mapEligibilities - Filter Branch Coverage")
class MapEligibilitiesFilterBranchCoverageTests {

    /**
     * Covers Line 3: if (!CollectionUtilities.isEmptyOrNull(eligibilities.getFiveGHomeBundle()))
     * Covers Line 5: .filter(bundle -> bundle != null && ...)
     * Target: fiveGHomeBundle contains null bundles - they should be filtered out
     */
    @Test
    @DisplayName("mapEligibilities - fiveGHomeBundle with null bundle filtered out")
    void testMapEligibilities_FiveGHomeBundleWithNullBundle_FilteredOut() {
        // Setup
        Eligibilities eligibilities = new Eligibilities();
        List<BundleInfo> bundles = new ArrayList<>();
        
        BundleInfo validBundle = new BundleInfo();
        validBundle.setBundleName("ValidBundle");
        bundles.add(validBundle);
        bundles.add(null);  // null bundle - should be filtered
        
        eligibilities.setFiveGHomeBundle(bundles);
        
        CustomerAddress enrichedAddress = new CustomerAddress();
        
        // Execute
        ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "mapEligibilities",
                enrichedAddress,
                eligibilities
        );
        
        // Verify - only valid bundle in list
        assertNotNull(enrichedAddress.getBundleList());
        assertEquals(1, enrichedAddress.getBundleList().size());
        assertEquals("ValidBundle", enrichedAddress.getBundleList().get(0));
    }

    /**
     * Covers Line 5: .filter(bundle -> ... && StringUtilities.isNotEmptyOrNull(bundle.getBundleName()))
     * Target: fiveGHomeBundle contains bundle with null/empty name - should be filtered
     */
    @Test
    @DisplayName("mapEligibilities - fiveGHomeBundle with empty bundleName filtered out")
    void testMapEligibilities_FiveGHomeBundleWithEmptyBundleName_FilteredOut() {
        // Setup
        Eligibilities eligibilities = new Eligibilities();
        List<BundleInfo> bundles = new ArrayList<>();
        
        BundleInfo bundleWithNullName = new BundleInfo();
        bundleWithNullName.setBundleName(null);
        bundles.add(bundleWithNullName);
        
        BundleInfo bundleWithEmptyName = new BundleInfo();
        bundleWithEmptyName.setBundleName("");
        bundles.add(bundleWithEmptyName);
        
        BundleInfo validBundle = new BundleInfo();
        validBundle.setBundleName("ValidBundleName");
        bundles.add(validBundle);
        
        eligibilities.setFiveGHomeBundle(bundles);
        
        CustomerAddress enrichedAddress = new CustomerAddress();
        
        // Execute
        ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "mapEligibilities",
                enrichedAddress,
                eligibilities
        );
        
        // Verify - only valid bundle remains
        assertNotNull(enrichedAddress.getBundleList());
        assertEquals(1, enrichedAddress.getBundleList().size());
        assertEquals("ValidBundleName", enrichedAddress.getBundleList().get(0));
    }

    /**
     * Covers Line 6: if (!CollectionUtilities.isEmptyOrNull(eligibilities.getCbandBundle()))
     * Covers Line 8: .filter(bundle -> bundle != null && ...)
     * Target: cbandBundle is not empty and contains null/empty bundles
     */
    @Test
    @DisplayName("mapEligibilities - cbandBundle with null and empty bundles filtered out")
    void testMapEligibilities_CbandBundleWithNullAndEmptyBundles_FilteredOut() {
        // Setup
        Eligibilities eligibilities = new Eligibilities();
        
        // cbandBundle with mixed content
        List<BundleInfo> cbandBundles = new ArrayList<>();
        cbandBundles.add(null);  // null bundle
        
        BundleInfo bundleWithNullName = new BundleInfo();
        bundleWithNullName.setBundleName(null);
        cbandBundles.add(bundleWithNullName);
        
        BundleInfo bundleWithEmptyName = new BundleInfo();
        bundleWithEmptyName.setBundleName("");
        cbandBundles.add(bundleWithEmptyName);
        
        BundleInfo validCbandBundle = new BundleInfo();
        validCbandBundle.setBundleName("ValidCbandBundle");
        cbandBundles.add(validCbandBundle);
        
        eligibilities.setCbandBundle(cbandBundles);
        // fiveGHomeBundle is null
        
        CustomerAddress enrichedAddress = new CustomerAddress();
        
        // Execute
        ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "mapEligibilities",
                enrichedAddress,
                eligibilities
        );
        
        // Verify
        assertNotNull(enrichedAddress.getBundleList());
        assertEquals(1, enrichedAddress.getBundleList().size());
        assertEquals("ValidCbandBundle", enrichedAddress.getBundleList().get(0));
    }

    /**
     * Covers both fiveGHomeBundle AND cbandBundle branches together
     */
    @Test
    @DisplayName("mapEligibilities - both bundle types with filtering")
    void testMapEligibilities_BothBundleTypesWithFiltering() {
        // Setup
        Eligibilities eligibilities = new Eligibilities();
        
        // fiveGHomeBundle
        List<BundleInfo> fiveGBundles = new ArrayList<>();
        BundleInfo fiveGValid = new BundleInfo();
        fiveGValid.setBundleName("FiveGBundle");
        fiveGBundles.add(fiveGValid);
        fiveGBundles.add(null);  // filtered out
        eligibilities.setFiveGHomeBundle(fiveGBundles);
        
        // cbandBundle
        List<BundleInfo> cbandBundles = new ArrayList<>();
        BundleInfo cbandValid = new BundleInfo();
        cbandValid.setBundleName("CbandBundle");
        cbandBundles.add(cbandValid);
        BundleInfo cbandEmpty = new BundleInfo();
        cbandEmpty.setBundleName("");  // filtered out
        cbandBundles.add(cbandEmpty);
        eligibilities.setCbandBundle(cbandBundles);
        
        CustomerAddress enrichedAddress = new CustomerAddress();
        
        // Execute
        ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "mapEligibilities",
                enrichedAddress,
                eligibilities
        );
        
        // Verify - both valid bundles present
        assertNotNull(enrichedAddress.getBundleList());
        assertEquals(2, enrichedAddress.getBundleList().size());
        assertTrue(enrichedAddress.getBundleList().contains("FiveGBundle"));
        assertTrue(enrichedAddress.getBundleList().contains("CbandBundle"));
    }

    /**
     * Covers: when all bundles filtered out, bundleList should NOT be set
     * Target: if (!allBundleNames.isEmpty()) { branch - false case
     */
    @Test
    @DisplayName("mapEligibilities - all bundles filtered out - bundleList not set")
    void testMapEligibilities_AllBundlesFilteredOut_BundleListNotSet() {
        // Setup - all bundles have null/empty names
        Eligibilities eligibilities = new Eligibilities();
        
        List<BundleInfo> bundles = new ArrayList<>();
        BundleInfo bundleNullName = new BundleInfo();
        bundleNullName.setBundleName(null);
        bundles.add(bundleNullName);
        
        BundleInfo bundleEmptyName = new BundleInfo();
        bundleEmptyName.setBundleName("");
        bundles.add(bundleEmptyName);
        
        bundles.add(null);
        
        eligibilities.setFiveGHomeBundle(bundles);
        
        CustomerAddress enrichedAddress = new CustomerAddress();
        
        // Execute
        ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "mapEligibilities",
                enrichedAddress,
                eligibilities
        );
        
        // Verify - bundleList should not be set (null or empty)
        assertTrue(enrichedAddress.getBundleList() == null || enrichedAddress.getBundleList().isEmpty());
    }
}

// ==================== LINE 12: hasInvalidCustomerAddress branch coverage ====================

@Nested
@DisplayName("hasInvalidCustomerAddress - Branch Coverage")
class HasInvalidCustomerAddressBranchCoverageTests {

    /**
     * Covers Line 12: return CollectionUtilities.isEmptyOrNull(customerAddresses) || ...
     * Target: true branch - list is null
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - null list returns true")
    void testHasInvalidCustomerAddress_NullList_ReturnsTrue() {
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                (List<CustomerAddress>) null
        );
        
        assertTrue(result);
    }

    /**
     * Covers Line 12: true branch - list is empty
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - empty list returns true")
    void testHasInvalidCustomerAddress_EmptyList_ReturnsTrue() {
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                new ArrayList<CustomerAddress>()
        );
        
        assertTrue(result);
    }

    /**
     * Covers: anyMatch branch - address is null
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - contains null address returns true")
    void testHasInvalidCustomerAddress_ContainsNullAddress_ReturnsTrue() {
        List<CustomerAddress> addresses = new ArrayList<>();
        CustomerAddress validAddr = new CustomerAddress();
        validAddr.setAddressLine1("123 Main St");
        validAddr.setZipCode("10001");
        addresses.add(validAddr);
        addresses.add(null);  // null address
        
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                addresses
        );
        
        assertTrue(result);
    }

    /**
     * Covers: anyMatch branch - addressLine1 is null
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - null addressLine1 returns true")
    void testHasInvalidCustomerAddress_NullAddressLine1_ReturnsTrue() {
        List<CustomerAddress> addresses = new ArrayList<>();
        CustomerAddress addr = new CustomerAddress();
        addr.setAddressLine1(null);
        addr.setZipCode("10001");
        addresses.add(addr);
        
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                addresses
        );
        
        assertTrue(result);
    }

    /**
     * Covers: anyMatch branch - zipCode is null
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - null zipCode returns true")
    void testHasInvalidCustomerAddress_NullZipCode_ReturnsTrue() {
        List<CustomerAddress> addresses = new ArrayList<>();
        CustomerAddress addr = new CustomerAddress();
        addr.setAddressLine1("123 Main St");
        addr.setZipCode(null);
        addresses.add(addr);
        
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                addresses
        );
        
        assertTrue(result);
    }

    /**
     * Covers: false branch - all addresses valid
     */
    @Test
    @DisplayName("hasInvalidCustomerAddress - all valid returns false")
    void testHasInvalidCustomerAddress_AllValid_ReturnsFalse() {
        List<CustomerAddress> addresses = new ArrayList<>();
        
        CustomerAddress addr1 = new CustomerAddress();
        addr1.setAddressLine1("123 Main St");
        addr1.setZipCode("10001");
        addresses.add(addr1);
        
        CustomerAddress addr2 = new CustomerAddress();
        addr2.setAddressLine1("456 Oak Ave");
        addr2.setZipCode("20002");
        addresses.add(addr2);
        
        Boolean result = ReflectionTestUtils.invokeMethod(
                validateBusinessAccountHelper,
                "hasInvalidCustomerAddress",
                addresses
        );
        
        assertFalse(result);
    }
}

// ==================== INTEGRATION TESTS FOR FULL FLOW COVERAGE ====================

@Nested
@DisplayName("Integration Tests - Full Flow Coverage")
class IntegrationFullFlowCoverageTests {

    /**
     * Integration test: Full flow with eligibilities containing null/empty bundles
     * This ensures mapEligibilities filter branches are hit through the main flow
     */
    @Test
    @DisplayName("check5GCoverageForAddresses - eligibilities with mixed bundles - filters applied")
    void testCheck5GCoverageForAddresses_EligibilitiesWithMixedBundles_FiltersApplied() {
        // Setup request
        FiveGCoverageCheckRequest request = new FiveGCoverageCheckRequest();
        List<CustomerAddress> customerAddresses = new ArrayList<>();
        CustomerAddress addr = new CustomerAddress();
        addr.setAddressLine1("123 Main St");
        addr.setZipCode("10001");
        addr.setCity("New York");
        addr.setState("NY");
        customerAddresses.add(addr);
        request.setCustomerAddress(customerAddresses);

        // Setup Split Address Response
        SplitAddressResponse splitResponse = createSplitAddressResponse();
        when(spectrumAdapterService.splitAddress(any(SplitAddressRequest.class)))
                .thenReturn(Mono.just(splitResponse));

        // Setup Nautilus Response with eligibilities containing null/empty bundles
        NautilusQualificationResponse nautilusResponse = new NautilusQualificationResponse();
        NautilusData data = new NautilusData();
        
        BulkAddressQualificationResponse qualification = new BulkAddressQualificationResponse();
        qualification.setRecordIdentifier("1");
        qualification.setReturnCode("0");
        qualification.setFiveGHomeQualified(true);
        
        // Eligibilities with mixed bundles (to test filtering)
        Eligibilities eligibilities = new Eligibilities();
        
        List<BundleInfo> fiveGBundles = new ArrayList<>();
        fiveGBundles.add(null);  // will be filtered
        BundleInfo emptyNameBundle = new BundleInfo();
        emptyNameBundle.setBundleName("");  // will be filtered
        fiveGBundles.add(emptyNameBundle);
        BundleInfo validBundle = new BundleInfo();
        validBundle.setBundleName("Gen4-5G-Home-Internet");
        fiveGBundles.add(validBundle);
        eligibilities.setFiveGHomeBundle(fiveGBundles);
        
        List<BundleInfo> cbandBundles = new ArrayList<>();
        BundleInfo cbandValid = new BundleInfo();
        cbandValid.setBundleName("CbandBundle");
        cbandBundles.add(cbandValid);
        cbandBundles.add(null);  // will be filtered
        eligibilities.setCbandBundle(cbandBundles);
        
        qualification.setEligibilities(eligibilities);
        
        AddressInfo addressInfo = new AddressInfo();
        addressInfo.setAddressId("123456");
        qualification.setAddressInfo(addressInfo);
        
        // Set capacity with null values to trigger default return
        AvailableCapacityInfo capacityInfo = new AvailableCapacityInfo();
        capacityInfo.setCbandCapacity(null);  // triggers return defaultValue
        capacityInfo.setLteCapacity("");       // triggers return defaultValue
        qualification.setAvailableCapacityInfo(capacityInfo);
        
        data.setBulkAddressQualificationResponse(Collections.singletonList(qualification));
        nautilusResponse.setData(data);
        
        when(spectrumAdapterService.checkAddressQualification(any(NautilusQualificationRequest.class)))
                .thenReturn(Mono.just(nautilusResponse));

        // Execute
        StepVerifier.create(validateBusinessAccountHelper.check5GCoverageForAddresses(request))
                .assertNext(response -> {
                    assertNotNull(response);
                    assertNotNull(response.getData());
                    assertNotNull(response.getData().getResponse());
                    
                    CustomerAddress resultAddr = response.getData().getResponse().getCustomerAddress().get(0);
                    
                    // Verify bundles were filtered (only 2 valid bundles remain)
                    assertNotNull(resultAddr.getBundleList());
                    assertEquals(2, resultAddr.getBundleList().size());
                    assertTrue(resultAddr.getBundleList().contains("Gen4-5G-Home-Internet"));
                    assertTrue(resultAddr.getBundleList().contains("CbandBundle"));
                    
                    // Verify capacity defaults were used
                    assertEquals(0, resultAddr.getAvailableCapacityCBand());
                    assertEquals(0, resultAddr.getAvailableCapacity4GHome());
                })
                .verifyComplete();
    }

    /**
     * Test to ensure createCustomerAddressCopy null branch is hit through error flow
     */
    @Test
    @DisplayName("processSplitAddressForCustomer - triggers createCustomerAddressCopy with valid address")
    void testProcessSplitAddressForCustomer_ErrorFlow_TriggersAddressCopy() {
        // Setup request with valid address
        FiveGCoverageCheckRequest request = new FiveGCoverageCheckRequest();
        List<CustomerAddress> customerAddresses = new ArrayList<>();
        CustomerAddress addr = new CustomerAddress();
        addr.setAddressLine1("123 Main St");
        addr.setZipCode("10001");
        customerAddresses.add(addr);
        request.setCustomerAddress(customerAddresses);

        // Setup Split Address to return error
        when(spectrumAdapterService.splitAddress(any(SplitAddressRequest.class)))
                .thenReturn(Mono.error(new RuntimeException("Split address service error")));

        // Execute - this will trigger onErrorResume which calls createCustomerAddressCopy
        StepVerifier.create(validateBusinessAccountHelper.check5GCoverageForAddresses(request))
                .assertNext(response -> {
                    assertNotNull(response);
                    // Error handling should have created a copy of the address with error status
                    assertNotNull(response.getData().getResponse().getCustomerAddress());
                })
                .verifyComplete();
    }
}

// ==================== HELPER METHOD (add to test class if not present) ====================

private SplitAddressResponse createSplitAddressResponse() {
    SplitAddressResponse response = new SplitAddressResponse();
    SplitAddressResponse.SplitAddressResponseData data = new SplitAddressResponse.SplitAddressResponseData();
    AddressSplit addressSplit = new AddressSplit();
    AddressSplit.AddressSplitServiceResponse serviceResponse = new AddressSplit.AddressSplitServiceResponse();
    
    onevz.soe.smbenrollment.responses.spectrumadapter.Address address = 
            new onevz.soe.smbenrollment.responses.spectrumadapter.Address();
    address.setStreetNum("123");
    address.setStreetName("Main");
    address.setType("St");
    address.setCity("New York");
    address.setState("NY");
    address.setZipCode("10001");
    address.setZipCode4("1234");
    address.setValidated(true);
    
    serviceResponse.setAddress(address);
    addressSplit.setResponse(serviceResponse);
    data.setAddressSplit(addressSplit);
    response.setData(data);
    
    return response;
}
